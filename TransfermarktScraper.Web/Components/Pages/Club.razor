@page "/clubs"

@using TransfermarktScraper.Web.Clients.Interfaces
@using TransfermarktScraper.Web.Services.Interfaces

@attribute [StreamRendering(true)]

@inject IClubClient ClubClient
@inject INavigationHistoryService NavigationHistoryService
@inject IItemSelectionService ItemSelectionService

<PageTitle>Clubs</PageTitle>

@if (clubs == null)
{
	<MudText HtmlTag="em">Scraping clubs please wait...</MudText>
}
else
{
	<MudGrid>
		<MudItem xs="2">
			<MudTextField Label="Search competitions..."
						  @bind-Value="SearchedCompetition"
						  Adornment="Adornment.Start"
						  AdornmentIcon="@Icons.Material.Filled.Search"
						  Immediate="true" />
		</MudItem>
		<MudSpacer />
		<MudItem xs="2" Class="d-flex justify-end">
			<MudButton Color="Color.Primary"
					   FullWidth="true"
					   Size="Size.Large"
					   Variant="Variant.Filled"
					   OnClick="SelectAllClubs">
				Select All
			</MudButton>
		</MudItem>
		<MudItem xs="2" Class="d-flex justify-end">
			<MudButton Color="Color.Primary"
					   FullWidth="true"
					   Size="Size.Large"
					   Variant="Variant.Filled">
				Scrape players
			</MudButton>
		</MudItem>
		<MudItem xs="2" Class="d-flex justify-end">
			<MudButton Color="Color.Primary"
					   FullWidth="true"
					   Size="Size.Large"
					   Variant="Variant.Filled"
					   OnClick="NavigateToPlayers">
				Check player stats
			</MudButton>
		</MudItem>
	</MudGrid>

	<MudList Dense="true" Gutters="true" T="Domain.DTOs.Response.Competition" Class="mt-6">
		@foreach (var competition in filteredCompetitions)
		{
			<MudListItem Ripple="false">
				<MudListSubheader @onclick="() => ToggleCompetitionSelection(competition)">
					<MudStack Row="true" AlignItems="AlignItems.Center">
						<MudAvatar>
							<MudImage Src="@competition.Logo" Alt="@competition.Name" />
						</MudAvatar>
						<MudSpacer />
						<MudText Typo="Typo.h6">@competition.Name</MudText>
						<MudSpacer />
						<MudIcon Icon="@(selectedCompetitions.Contains(competition)
							? Icons.Material.Filled.ArrowDropUp
							: Icons.Material.Filled.ArrowDropDown)"
								 Color="Color.Primary"
								 Size="Size.Large" />
					</MudStack>
				</MudListSubheader>

				<MudCollapse Expanded="@selectedCompetitions.Contains(competition)">
					<MudDataGrid T="Domain.DTOs.Response.Club"
								 Dense="true"
								 Hover="true"
								 Filterable="false"
								 MultiSelection="true"
								 ColumnResizeMode="ResizeMode.None"
								 SelectedItems="@ItemSelectionService.SelectedClubs"
								 @key="competition.TransfermarktId"
								 Items="@GetClubs(competition)">
						<Columns>
							<SelectColumn T="Domain.DTOs.Response.Club" />
							<TemplateColumn T="Domain.DTOs.Response.Club" Title="Crest">
								<CellTemplate>
									<MudAvatar>
										<MudImage Src="@context.Item.Crest" Alt="@context.Item.Name" />
									</MudAvatar>
								</CellTemplate>
							</TemplateColumn>
							<PropertyColumn Property="x => x.Name" Sortable="false" />
							<PropertyColumn Property="x => x.MarketValue" Title="Market value" Sortable="false" />
							<PropertyColumn Property="x => x.PlayersCount" Title="Number of players" Sortable="false" />
							<PropertyColumn Property="x => x.AgeAverage" Title="Age average" Sortable="false" />
							<PropertyColumn Property="x => x.ForeignersCount" Title="Number of foreigners" Sortable="false" />
							<PropertyColumn Property="x => x.MarketValueAverage" Title="Average market value" Sortable="false" />
						</Columns>
					</MudDataGrid>
				</MudCollapse>

			</MudListItem>
		}
	</MudList>
}


@code {
	private Dictionary<string, IEnumerable<Domain.DTOs.Response.Club>> clubs = null!;
	private HashSet<Domain.DTOs.Response.Competition> competitions = null!;
	private HashSet<Domain.DTOs.Response.Competition> selectedCompetitions = new();
	private HashSet<Domain.DTOs.Response.Competition> filteredCompetitions = new();
	private string _searchedCompetition = string.Empty;

	private string SearchedCompetition
	{
		get => _searchedCompetition;	
		set
		{
			if (_searchedCompetition != value)
			{
				_searchedCompetition = value;
				FilterCompetitions();
			}
		}
	}

	protected override async Task OnInitializedAsync()
	{
		competitions = ItemSelectionService.SelectedCompetitions;

		filteredCompetitions = competitions;

		foreach(var competition in ItemSelectionService.SelectedCompetitions)
		{
			var clubsList = await ClubClient.GetClubsAsync(competition.TransfermarktId);

			clubs = new Dictionary<string, IEnumerable<Domain.DTOs.Response.Club>>
			{
				[competition.TransfermarktId] = clubsList
			};
		}
	}

	private IEnumerable<Domain.DTOs.Response.Club> GetClubs(Domain.DTOs.Response.Competition competition)
	{
		clubs.TryGetValue(competition.TransfermarktId, out var clubsList);

		return clubsList ?? Enumerable.Empty<Domain.DTOs.Response.Club>();
	}

	private void ToggleCompetitionSelection(Domain.DTOs.Response.Competition competition)
	{
		if (!selectedCompetitions.Add(competition))
		{
			selectedCompetitions.Remove(competition);
		}
	}

	private void SelectAllClubs()
	{
		if (ItemSelectionService.SelectedClubs.Count() == ItemSelectionService.SelectedCompetitions.SelectMany(competition => competition.ClubIds).Count())
		{
			ItemSelectionService.SelectedClubs = new HashSet<Domain.DTOs.Response.Club>();
		}
		else
		{
			ItemSelectionService.SelectedClubs = clubs.SelectMany(kvp => kvp.Value).ToHashSet();
		}
	}

	private void FilterCompetitions()
	{
		filteredCompetitions = competitions?
			.Where(competition => competition.Name.Contains(_searchedCompetition, StringComparison.OrdinalIgnoreCase))
			.ToHashSet() ?? new HashSet<Domain.DTOs.Response.Competition>();
	}

	private void NavigateToPlayers()
	{
		NavigationHistoryService.NavigateTo("/players");
	}
}
