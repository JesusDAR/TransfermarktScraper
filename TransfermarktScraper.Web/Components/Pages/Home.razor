@page "/start"

@using TransfermarktScraper.Web.Clients.Interfaces
@using TransfermarktScraper.Web.Services.Interfaces

@inject IJSRuntime JSRuntime
@inject ICountryClient CountryClient
@inject IMasterClient MasterClient
@inject IExporterClient ExporterClient
@inject ISettingsClient SettingsClient
@inject INavigationHistoryService NavigationHistoryService

<PageTitle>Start</PageTitle>

<MudGrid ustify="Justify.Center" Spacing="2" Class="mt-6">
    <MudItem xs="12" Class="d-flex justify-center">
        <MudText>
            Massive scraping of all data from Transfermarkt (The process will take a long time to complete)
        </MudText>
    </MudItem>
</MudGrid>
<MudGrid Justify="Justify.Center" Spacing="2" Class="mt-6">
    <MudItem md="2" Class="d-flex justify-center">
        <MudButton Color="Color.Error"
                   Size="Size.Large"
                   Variant="Variant.Filled"
                   OnClick="CleanDatabaseAsync">
            Clean Database
        </MudButton>
    </MudItem>
    <MudItem md="2">
        <MudStack Row="true">
            <MudSelect Label="Select exporting format"
                       T="string"
                       @bind-value="_selectedFormat">
                @{
                    if (formats != null)
                    {
                        foreach (var format in formats)
                        {
                            <MudSelectItem Value="@format">@format</MudSelectItem>
                        }
                    }
                }
            </MudSelect>
            <MudIconButton Disabled="string.IsNullOrEmpty(_selectedFormat)"
                           Icon="@Icons.Material.Filled.Download"
                           OnClick="ExportCountryCompetitionDataAsync" />
        </MudStack>
    </MudItem>
    <MudItem md="2" Class="d-flex justify-center">
        <MudButton Color="Color.Primary"
                   Size="Size.Large"
                   Variant="Variant.Filled"          
                   OnClick="ScrapeAllAsync">
            Scrape all data
        </MudButton>
    </MudItem>

</MudGrid>

<MudDivider DividerType="DividerType.Middle" Class="mt-12 mb-12 my-6" />

<MudGrid Justify="Justify.Center" Spacing="2">
    <MudItem xs="12" Class="d-flex justify-center">
        <MudText>
            Options to configure the step by step scraping process
        </MudText>
    </MudItem>
</MudGrid>
<MudGrid Justify="Justify.Center" Spacing="2" Class="mt-6">
    <MudItem md="2">
        <MudSelect Label="Visual scraping mode"
                   T="bool"
                   Value="_selectedHeadlessMode"
                   ValueChanged="OnSelectedHeadlessModeChanged">
            <MudSelectItem Value="true">Disabled</MudSelectItem>
            <MudSelectItem Value="false">Enabled</MudSelectItem>
        </MudSelect>
    </MudItem>
    <MudItem md="2">
        <MudSelect Label="Always force scraping mode"
                   T="bool"
                   Value="_selectedForceScrapingMode"
                   ValueChanged="OnSelectedForceScrapingModeChanged">
            <MudSelectItem Value="true">Enabled</MudSelectItem>
            <MudSelectItem Value="false">Disabled</MudSelectItem>
        </MudSelect>
    </MudItem>
    <MudItem md="2">
        <MudNumericField Label="Number of countries to scrape"
                         T="int"
                         Value="_selectedCountriesCountToScrape"
                         ValueChanged="OnSelectedCountriesCountToScrapeChanged"
                         Variant="Variant.Text"
                         Min="0">
        </MudNumericField>
    </MudItem>
</MudGrid>

<MudGrid Justify="Justify.Center" Spacing="2" Class="mt-12">
    <MudItem xs="12" Class="d-flex justify-center">
        <MudText>
            Click here to start the step by step scraping process
        </MudText>
    </MudItem>
</MudGrid>
<MudGrid Justify="Justify.Center" Class="mt-3">
    <MudItem>
        <MudButton Color="Color.Primary"
                   Size="Size.Large"
                   Variant="Variant.Filled"
                   OnClick="NavigateToCountry">
            Scrape countries
        </MudButton>
    </MudItem>
</MudGrid>

@code {
    private bool _selectedHeadlessMode;
    private bool _selectedForceScrapingMode;
    private int _selectedCountriesCountToScrape;
    private string _selectedFormat = string.Empty;
    private IEnumerable<string> formats = null!;

    protected override async Task OnInitializedAsync()
    {
        var settings = await SettingsClient.GetSettingsAsync();
        _selectedCountriesCountToScrape = settings.CountriesCountToScrape;
        _selectedForceScrapingMode = settings.IsForceScraping;
        _selectedHeadlessMode = settings.IsHeadlessMode;
        formats = await GetSupportedFormatsAsync();
    }

    private async Task OnSelectedHeadlessModeChanged(bool selectedHeadlessMode)
    {
        _selectedHeadlessMode = selectedHeadlessMode;
        await SettingsClient.SetHeadlessModeAsync(_selectedHeadlessMode);
    }

    private async Task OnSelectedForceScrapingModeChanged(bool selectedForceScrapingMode)
    {
        _selectedForceScrapingMode = selectedForceScrapingMode;
        await SettingsClient.SetForceScrapingAsync(_selectedForceScrapingMode);
    }

    private async Task OnSelectedCountriesCountToScrapeChanged(int selectedCountriesCountToScrape)
    {
        _selectedCountriesCountToScrape = selectedCountriesCountToScrape;
        await SettingsClient.SetCountriesCountToScrapeAsync(_selectedCountriesCountToScrape);
    }

    private void NavigateToCountry()
    {
        NavigationHistoryService.NavigateTo("/countries");
    }

    private async Task ScrapeAllAsync()
    {
    }

    private async Task<IEnumerable<string>> GetSupportedFormatsAsync()
    {
        var result = await SettingsClient.GetSupportedFormatsAsync();

        result = result.Select(format => format.ToUpperInvariant());

        return result;
    }

    private async Task ExportCountryCompetitionDataAsync()
    {
        var fileContentResult = await ExporterClient.ExportMasterDataAsync(_selectedFormat, default);

        if (fileContentResult != null)
        {
            await JSRuntime.InvokeVoidAsync("downloadFile", fileContentResult.Base64, fileContentResult.Name, fileContentResult.Format);
        }
    }

    private async Task CleanDatabaseAsync()
    {
        await MasterClient.CleanDatabaseAsync(default);
    }
}